# CSRF Token using session

To implement CSRF protection in a Spring Boot application without using Spring Security, you can manually implement CSRF
protection by following these steps:

**Steps to Implement CSRF Protection:**

1. **Generate a CSRF Token**:

A CSRF token is a unique token that is generated by the server and embedded in the HTML form. This token will be
included in each subsequent request made by the client.

Create a utility class to generate and store the CSRF token.

```
import java.security.SecureRandom;
import java.util.Base64;

public class CSRFTokenUtil {

    private static final SecureRandom secureRandom = new SecureRandom();

    public static String generateToken() {
        byte[] randomBytes = new byte[32];
        secureRandom.nextBytes(randomBytes);
        return Base64.getUrlEncoder().withoutPadding().encodeToString(randomBytes);
    }
}
```

2. **Store the CSRF Token**:

You need to store the CSRF token for comparison when the form is submitted. This can be done in the session or as an
HTTP cookie.

Here’s how to store the token in the session:

```
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

@Component
public class CSRFTokenService {

    public void storeToken(String token) {
        ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        requestAttributes.getRequest().getSession().setAttribute("csrfToken", token);
    }

    public String getToken() {
        ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        return (String) requestAttributes.getRequest().getSession().getAttribute("csrfToken");
    }

    public boolean isValid(String token) {
        String storedToken = getToken();
        return storedToken != null && storedToken.equals(token);
    }
}
```

3. **Add the CSRF Token to the Form**:

In your HTML form, include the CSRF token as a hidden field.

Example HTML:

```
<form action="/submit" method="post">
    <input type="hidden" name="csrfToken" value="${csrfToken}">
    <!-- other form fields -->
    <button type="submit">Submit</button>
</form>
```

4. **Generate and Attach CSRF Token in a Controller**:

When rendering a page, generate a CSRF token and store it in the session. Pass this token to your view.

Example Controller:

```
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;

@Controller
public class CSRFController {

    @Autowired
    private CSRFTokenService csrfTokenService;

    @GetMapping("/form")
    public String showForm(Model model) {
        // Generate a new CSRF token
        String csrfToken = CSRFTokenUtil.generateToken();
        // Store the token in the session
        csrfTokenService.storeToken(csrfToken);
        // Pass the token to the model
        model.addAttribute("csrfToken", csrfToken);
        return "form";
    }

    @PostMapping("/submit")
    public String handleSubmit(String csrfToken) {
        // Validate the CSRF token
        if (csrfTokenService.isValid(csrfToken)) {
            // Token is valid, proceed with form processing
            return "success";
        } else {
            // Invalid token, return error
            return "error";
        }
    }
}
```

5. **Validate the CSRF Token on Request**:

When handling a form submission, you need to validate the CSRF token to ensure that it matches the token stored in the
session.

In the example above, this validation is done in the handleSubmit method of the controller.

**Notes:**

•    **Session-based Storage**: The CSRF token is stored in the session, but you can store it in a secure HTTP cookie if
needed.

•    **Token Generation**: The token is generated using SecureRandom to ensure uniqueness and randomness. It’s encoded
in a URL-safe Base64 format.

•    **Form Embedding**: Each form that requires CSRF protection will need to include the CSRF token as a hidden field.

•    **Token Validation**: The token submitted with the form is compared against the one stored in the session to ensure
that it’s valid.

This approach provides basic CSRF protection without using Spring Security. However, for more comprehensive security
features like protection against other threats (e.g., session fixation, clickjacking), it’s advisable to use Spring
Security.